{"ast":null,"code":"import React,{useEffect}from'react';import{useForm,useWatch}from'react-hook-form';import*as yup from'yup';import{useQuery}from'react-query';import{categoryAPI}from'../../api/categoryAPI';import{authorAPI}from'../../api/authorAPI';import{uploadAPI}from'../../api/uploadAPI';import Loading from'../common/Loading';import toast from'react-hot-toast';import{jsx as _jsx,jsxs as _jsxs}from\"react/jsx-runtime\";const schema=yup.object().shape({title:yup.string().min(1,'Tên sách ít nhất 1 ký tự').required('Tên sách là bắt buộc'),authorId:yup.string().required('Tác giả là bắt buộc'),description:yup.string().min(1,'Mô tả ít nhất 1 ký tự').required('Mô tả là bắt buộc'),price:yup.number().typeError('Giá phải là một con số').positive('Giá phải là số dương').required('Giá là bắt buộc'),quantity:yup.number().typeError('Số lượng phải là một con số').integer('Số lượng phải là số nguyên').min(0,'Số lượng không được âm').required('Số lượng là bắt buộc'),category:yup.string().required('Danh mục là bắt buộc'),images:yup.array().of(yup.string().required('URL ảnh là bắt buộc')).min(1,'Cần ít nhất một hình ảnh').required('Hình ảnh là bắt buộc')});const BookForm=_ref=>{let{onSubmit,initialData,isSubmitting,submitButtonText='Lưu'}=_ref;const{data:categories,isLoading:isLoadingCategories,error:categoriesError}=useQuery('categories',categoryAPI.getAllCategories);const{data:authors,isLoading:isLoadingAuthors,error:authorsError}=useQuery('authors',authorAPI.getAllAuthors);const{register,handleSubmit,control,reset,setValue,getValues,formState:{errors}}=useForm({// resolver: yupResolver(schema), // Temporarily disable validation\ndefaultValues:{images:[]}});const imagesValue=useWatch({control,name:'images'});useEffect(()=>{if(initialData&&authors){var _authors$find;// Find authorId from author name\nconst authorId=((_authors$find=authors.find(author=>author.name===initialData.author))===null||_authors$find===void 0?void 0:_authors$find._id)||'';console.log('🔄 Setting initial data:',{...initialData,category:initialData.category._id,authorId:authorId,foundAuthor:authors.find(author=>author.name===initialData.author)});reset({...initialData,category:initialData.category._id,authorId:authorId});}},[initialData,authors,reset]);const handleFormSubmit=data=>{console.log('🔥 Form submitted with data:',data);console.log('🔍 Form validation errors:',errors);console.log('📋 isSubmitting state:',isSubmitting);try{onSubmit(data);}catch(error){console.error('🚨 Error in handleFormSubmit:',error);}};const handleFileChange=async e=>{var _e$target$files;console.log('📁 File input changed:',(_e$target$files=e.target.files)===null||_e$target$files===void 0?void 0:_e$target$files.length);if(!e.target.files)return;const files=Array.from(e.target.files);for(const file of files){const validation=uploadAPI.validateFile(file);if(!validation.isValid){toast.error(String(validation.error||'File không hợp lệ'));continue;}try{toast.loading('Đang tải ảnh lên...',{id:'upload'});const url=await uploadAPI.uploadImage(file);const current=getValues('images')||[];setValue('images',[...current,url]);toast.success('Tải ảnh thành công',{id:'upload'});console.log('✅ Image uploaded:',url);}catch(err){const msg=err&&typeof err==='object'&&'message'in err?err.message:'Lỗi tải ảnh';toast.error(String(msg),{id:'upload'});console.error('❌ Image upload error:',err);}}e.target.value='';};if(isLoadingCategories||isLoadingAuthors)return/*#__PURE__*/_jsx(Loading,{});if(categoriesError||authorsError)return/*#__PURE__*/_jsx(\"p\",{className:\"text-red-500\",children:\"L\\u1ED7i khi t\\u1EA3i danh m\\u1EE5c ho\\u1EB7c t\\xE1c gi\\u1EA3.\"});return/*#__PURE__*/_jsxs(\"form\",{onSubmit:e=>{console.log('📝 Form onSubmit triggered!');console.log('📋 Form data before handleSubmit:',getValues());console.log('🔍 Current validation errors:',errors);console.log('📊 Form validation state:',{isValid:Object.keys(errors).length===0,errorCount:Object.keys(errors).length,errors:errors});// Prevent default and call handleSubmit manually to debug\ne.preventDefault();const formData=getValues();console.log('📋 About to validate and submit:',formData);// Call handleSubmit manually with better error handling\nhandleSubmit(data=>{console.log('✅ Validation passed, calling handleFormSubmit with:',data);handleFormSubmit(data);},errors=>{console.error('❌ Validation failed with errors:',errors);})(e);},className:\"space-y-6 bg-white p-8 rounded-lg shadow-md\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"grid grid-cols-1 md:grid-cols-2 gap-6\",children:[/*#__PURE__*/_jsxs(\"div\",{children:[/*#__PURE__*/_jsx(\"label\",{htmlFor:\"title\",className:\"block text-sm font-medium text-gray-700\",children:\"T\\xEAn s\\xE1ch\"}),/*#__PURE__*/_jsx(\"input\",{id:\"title\",type:\"text\",...register('title'),className:`mt-1 block w-full px-3 py-2 border ${errors.title?'border-red-500':'border-gray-300'} rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500`}),errors.title&&/*#__PURE__*/_jsx(\"p\",{className:\"mt-2 text-sm text-red-600\",children:errors.title.message})]}),/*#__PURE__*/_jsxs(\"div\",{children:[/*#__PURE__*/_jsx(\"label\",{htmlFor:\"author\",className:\"block text-sm font-medium text-gray-700\",children:\"T\\xE1c gi\\u1EA3\"}),/*#__PURE__*/_jsxs(\"select\",{id:\"author\",...register('authorId'),className:`mt-1 block w-full px-3 py-2 border ${errors.authorId?'border-red-500':'border-gray-300'} rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500`,children:[/*#__PURE__*/_jsx(\"option\",{value:\"\",children:\"Ch\\u1ECDn t\\xE1c gi\\u1EA3\"}),authors===null||authors===void 0?void 0:authors.map(author=>/*#__PURE__*/_jsx(\"option\",{value:author._id,children:author.name},author._id))]}),errors.authorId&&/*#__PURE__*/_jsx(\"p\",{className:\"mt-2 text-sm text-red-600\",children:errors.authorId.message})]})]}),/*#__PURE__*/_jsxs(\"div\",{children:[/*#__PURE__*/_jsx(\"label\",{htmlFor:\"description\",className:\"block text-sm font-medium text-gray-700\",children:\"M\\xF4 t\\u1EA3\"}),/*#__PURE__*/_jsx(\"textarea\",{id:\"description\",rows:4,...register('description'),className:`mt-1 block w-full px-3 py-2 border ${errors.description?'border-red-500':'border-gray-300'} rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500`}),errors.description&&/*#__PURE__*/_jsx(\"p\",{className:\"mt-2 text-sm text-red-600\",children:errors.description.message})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"grid grid-cols-1 md:grid-cols-3 gap-6\",children:[/*#__PURE__*/_jsxs(\"div\",{children:[/*#__PURE__*/_jsx(\"label\",{htmlFor:\"price\",className:\"block text-sm font-medium text-gray-700\",children:\"Gi\\xE1\"}),/*#__PURE__*/_jsx(\"input\",{id:\"price\",type:\"number\",...register('price'),className:`mt-1 block w-full px-3 py-2 border ${errors.price?'border-red-500':'border-gray-300'} rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500`}),errors.price&&/*#__PURE__*/_jsx(\"p\",{className:\"mt-2 text-sm text-red-600\",children:errors.price.message})]}),/*#__PURE__*/_jsxs(\"div\",{children:[/*#__PURE__*/_jsx(\"label\",{htmlFor:\"quantity\",className:\"block text-sm font-medium text-gray-700\",children:\"S\\u1ED1 l\\u01B0\\u1EE3ng\"}),/*#__PURE__*/_jsx(\"input\",{id:\"quantity\",type:\"number\",...register('quantity'),className:`mt-1 block w-full px-3 py-2 border ${errors.quantity?'border-red-500':'border-gray-300'} rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500`}),errors.quantity&&/*#__PURE__*/_jsx(\"p\",{className:\"mt-2 text-sm text-red-600\",children:errors.quantity.message})]}),/*#__PURE__*/_jsxs(\"div\",{children:[/*#__PURE__*/_jsx(\"label\",{htmlFor:\"category\",className:\"block text-sm font-medium text-gray-700\",children:\"Danh m\\u1EE5c\"}),/*#__PURE__*/_jsxs(\"select\",{id:\"category\",...register('category'),className:`mt-1 block w-full px-3 py-2 border ${errors.category?'border-red-500':'border-gray-300'} bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500`,children:[/*#__PURE__*/_jsx(\"option\",{value:\"\",children:\"Ch\\u1ECDn danh m\\u1EE5c\"}),categories===null||categories===void 0?void 0:categories.map(cat=>/*#__PURE__*/_jsx(\"option\",{value:cat._id,children:cat.name},cat._id))]}),errors.category&&/*#__PURE__*/_jsx(\"p\",{className:\"mt-2 text-sm text-red-600\",children:errors.category.message})]})]}),/*#__PURE__*/_jsxs(\"div\",{children:[/*#__PURE__*/_jsx(\"label\",{className:\"block text-sm font-medium text-gray-700 mb-2\",children:\"H\\xECnh \\u1EA3nh s\\xE1ch\"}),/*#__PURE__*/_jsxs(\"div\",{className:\"mb-4\",children:[/*#__PURE__*/_jsx(\"input\",{type:\"file\",accept:\"image/*\",multiple:true,className:\"hidden\",id:\"fileInput\",onChange:handleFileChange}),/*#__PURE__*/_jsxs(\"label\",{htmlFor:\"fileInput\",className:\"inline-flex items-center px-4 py-2 bg-blue-600 text-white font-medium rounded-md hover:bg-blue-700 cursor-pointer transition-colors\",children:[/*#__PURE__*/_jsx(\"svg\",{className:\"w-5 h-5 mr-2\",fill:\"none\",stroke:\"currentColor\",viewBox:\"0 0 24 24\",children:/*#__PURE__*/_jsx(\"path\",{strokeLinecap:\"round\",strokeLinejoin:\"round\",strokeWidth:2,d:\"M12 6v6m0 0v6m0-6h6m-6 0H6\"})}),\"T\\u1EA3i \\u1EA3nh l\\xEAn\"]}),imagesValue&&imagesValue.length>0&&/*#__PURE__*/_jsxs(\"span\",{className:\"ml-3 text-sm text-gray-600\",children:[\"\\u0110\\xE3 c\\xF3 \",imagesValue.length,\" \\u1EA3nh\"]})]}),imagesValue&&imagesValue.length>0&&/*#__PURE__*/_jsx(\"div\",{className:\"grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 mb-4\",children:imagesValue.map((url,index)=>/*#__PURE__*/_jsxs(\"div\",{className:\"relative group\",children:[/*#__PURE__*/_jsx(\"img\",{src:url,alt:`Preview ${index+1}`,className:\"w-full h-24 object-cover rounded-lg border border-gray-300\",onError:e=>{e.currentTarget.src='/placeholder-image.png';}}),/*#__PURE__*/_jsx(\"button\",{type:\"button\",onClick:()=>{const current=getValues('images')||[];setValue('images',current.filter((_,i)=>i!==index));},className:\"absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs hover:bg-red-600 opacity-0 group-hover:opacity-100 transition-opacity\",children:\"\\xD7\"})]},index))}),errors.images&&/*#__PURE__*/_jsx(\"p\",{className:\"mt-2 text-sm text-red-600\",children:errors.images.message})]}),/*#__PURE__*/_jsx(\"div\",{className:\"flex justify-end\",children:/*#__PURE__*/_jsx(\"button\",{type:\"submit\",disabled:isSubmitting,onClick:()=>console.log('🖱️ Submit button clicked!'),className:\"inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 disabled:bg-indigo-300\",children:isSubmitting?'Đang xử lý...':submitButtonText})})]});};export default BookForm;","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}